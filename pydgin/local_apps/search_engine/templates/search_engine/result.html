{% extends "base.html" %}
{% block title %}{{ query }}{% endblock %}
{% block header %}
<script>
$(document).ready(function() {
	// set dropdown list to idx selected
	$('#idx').val("{{ idx_name}}");
	
	// event handlers
	$('#categories').on( "click", "li", function(event) {
	    var cat = $(this).attr('id').replace('bucket-', '');
	    search_engine.toggle_category(cat);
	});

	$('#advanced-filters,#biotypes').on( "click", "input", function(event) {
		$("#search-form").submit();
	});
	$('#maxsize').on( "change", function(event) {
		$("#search-form").submit();
	});

	$('a[data-toggle="pill"]').on('shown.bs.tab', function (e) {
		// save the latest tab in local storage
		localStorage.setItem('searchLastTab', $(this).attr('href'));
	});

	// go to the latest tab, if it exists:
	 var lastTab = localStorage.getItem('searchLastTab');
	 if (lastTab && $('[href="' + lastTab + '"]').length) {
		 $('[href="' + lastTab + '"]').tab('show');
		 search_engine.toggle_category(lastTab.replace('#', ''));
	 } else {
		 var cat = $('#categories > li.active').attr('id').replace('bucket-', '');
		 search_engine.toggle_category(cat);
	 }

	 // gene comparison
	 $( "#gene-compare" ).submit(function( event ) {
		  event.preventDefault();
		  var features = '';
		  $("#"+event.target.id+" input:checkbox:checked").each(function() {
			    features += ','+this.id;
		  });
		  location.href = "/gene/?g=" + features.substring(1);
	});
});
</script>
{% endblock %}

{% block content %}
{% load filter_tags %}
{% load pydgin_tags %}
{% load search_engine_tags %}

<div class="row">
<div class="col-md-4">
<form class="form" id="search-form" method="post">{% csrf_token %}
	<input type="hidden" name="query" value="{{ query }}"><input type="hidden" name="idx" value="{{ idx_name }}">
</div>
</div>

{% if not data %}
<p>No results found for <strong>{{ query }}</strong>.</p>
{% endif %}
<div class="row">
<div class="col-md-3">
	<!-- INDEX CATEGORIES -->
	<p>&nbsp;</p>
	<div>
		<ul id="categories" class="nav nav-pills nav-stacked">
		{% for data_key, data_val in data.items|sort %}
			<li id="bucket-{{ data_key }}" role="presentation" {% if forloop.counter == 1 %}class="active"{% endif %}>
				<input type="hidden" name="categories" value="{{ data_key }}">
				<a href="#{{ data_key }}" data-toggle="pill">{{ data_key }} <span class="badge">{{ data_val.doc_count }}</span></a>
			</li>
		{% endfor %}
		</ul>
	</div>
	<!-- BIOTYPES -->
	<br/>
	{% for agg, agg_value in aggs.items|sort %}
	  {% if agg_value.get_buckets and agg == 'biotypes' %}
		<div class="panel panel-info collapse" id="biotypes">
		<div class="panel-heading"><h4 class="panel-title">{{ agg }}</h4></div>
		<div class="panel-body">
		{% for bucket in agg_value.get_buckets|sort %}
			<div class="checkbox">
			<label><input type="checkbox" name="biotypes" value="{{ bucket.key }}" {% if bucket.doc_count > 0 %}checked{% endif %}>
			{{ bucket.key }} <span class="badge">{{ bucket.doc_count }}</span></label>
			<input type="hidden" name="saved-biotypes" value="{{ bucket.key }}">
			</div>
		{% endfor %}
		</div>
		</div>
	  {% endif %}
	{% endfor %}

	<!-- ADVANCED FILTERS -->
	<a class="btn btn-sm btn-primary" role="button" data-toggle="collapse" href="#advanced-filters"
	aria-expanded="false" aria-controls="advanced-filters">Advanced filters</a><br /><br />
	<div class="collapse" id="advanced-filters">
	{% for idx, idxmap in mappings.items|sort %}
		<div class="panel panel-info collapse" id="filter-{{ idx|lower }}">
		<div class="panel-heading"><h4 class="panel-title">{{ idx }}</h4></div>
		<div class="panel-body">
		{% for type, values in idxmap.mappings.items|sort %}
			{% if idxmap.mappings|length > 1 %}<strong>{{ type }}</strong>{% endif %}
			{% for para, para_type in values.properties.items|sort %}
			    {% if para_type.properties %}
			    	<div class="panel panel-default">
			        <div class="panel-body">
			        <div>{{ para }}:</div>
			    	{% for subpara, subpara_type in para_type.properties.items|sort %}
			    			<div class="checkbox"><label>
			    			<input type="checkbox" name="{{ type }}_{{ para }}_{{ subpara }}" value="{{ type }}:{{ para }}:{{ subpara }}"
			    				{% if para.subpara in fields or para|add:"."|add:subpara in fields %}checked{% endif %}>{{ subpara }}</label></div>
			    	{% endfor %}
			    	</div></div>
			    {% elif "string" == para_type.type %}
			        <div class="checkbox">
			    		<label><input type="checkbox" name="{{ type }}_{{ para }}" value="{{ type }}:{{ para }}" 
			    			{% if para in fields %}checked{% endif %}>{{ para }}</label>
			    	</div>
		        {% endif %}
			{% endfor %}
		{% endfor %}
		</div></div>
	{% endfor %}
	</div>
</form>
</div> <!-- end of column -->

<!-- HITS -->
<div class="col-md-9">
<div class="pull-right form-inline">
	<label>Max Hits:</label>
	<select id="maxsize" name="maxsize" class="form-control input-sm" form="search-form">
		<option value="20" {% if maxsize == 20 %}selected="selected"{% endif %}>20</option>
		<option value="50" {% if maxsize == 50 %}selected="selected"{% endif %}>50</option>
		<option value="100" {% if maxsize == 100 %}selected="selected"{% endif %}>100</option> 
	</select>
</div>

<div class="tab-content">
{% for data_key, data_val in data.items|sort %}
	<div id="{{ data_key }}" class="tab-pane fade in {% if forloop.counter == 1 %}active{% endif %}">

	{% for doc in data_val.docs %}

		{% if forloop.counter == 1 %}
			<p>{{ data_val.docs|length }} of {{ data_val.doc_count }} hit(s) for '{{ query }}':</p>
			{% if data_val.docs|length > 1 and doc|doc_comparable %}
				<form id="{{ data_key }}-compare" class="form-inline">
				<button type="submit" class="input-sm btn btn-primary" style="margin-bottom:1em">Compare Selected</button>
			{% endif %}
		{% endif %}

		<div class="panel panel-default"><div class="panel-body">
  		<div class="row"> <!-- panel row -->
		<div class="col-md-2 col-lg-1">
			<h4 style="margin-top: 0"><span class="label label-success">{{ doc|doc_type }}</span></h4>
			<span style="white-space: nowrap;"><strong><a href="{{ doc|doc_url }}{{ doc|doc_link_id }}"
			     {% if doc|doc_ext %}target="_blank"{% endif %}>{{ doc|doc_name }}</a></strong></span>
			{% if doc|doc_comparable and data_val.docs|length > 1 %}
				<div class="checkbox"><input id="{{ doc|doc_link_id }}" type="checkbox"></div>
			{% endif %}
		</div>

		<div class="col-md-10 col-lg-11">
			<!-- highlight fields matching search -->
			{% with '<strong> </strong>' as tags %} {% with doc|doc_highlight as frags %}
			{% for key, vals in frags.items %}
				<div class="row"> <!-- details row -->
				   <div class="col-sm-2 col-xs-3 text-right"><strong>{{ key }}</strong></div>
				   <div class="col-sm-10 col-xs-9">
				   {% for html_frag in vals %}
					   {% if html_frag in tags %}
							{{ html_frag|safe }}
					   {% else %}
							{{ html_frag }}
					   {% endif %}
				   {% endfor %}
				   </div>
				</div>
			{% endfor %}
			{% endwith %} {% endwith %}

			<!-- other fields -->
			{% for key in doc|doc_keys %}
				{% if key != "_meta" and key not in doc|doc_highlight_keys %}
					<div class="row"> <!-- details row -->
					    <div class="col-sm-2 col-xs-3 text-right"><strong>{{ key }}</strong></div>
					    <div class="col-sm-10 col-xs-9">
					    {% if key == 'dbxrefs' %}
						    Ensembl:{{ doc|doc_attr:key|get_item:'ensembl' }}; Entrez:{{ doc|doc_attr:key|get_item:'entrez' }}
					    {% else %}
							{{ doc|doc_attr_str:key }}
						{%endif %}
						</div>
					</div>
				{% endif %}
			{% endfor %}
		</div>
		</div> <!-- panel row -->
		</div></div>

	{% endfor %}
	{% if doc|doc_comparable %}<!-- compare features form --></form>{% endif %}
	</div>
{% endfor %}
</div>

</div> <!-- end of column -->
</div> <!-- end of row -->
{% endblock %}